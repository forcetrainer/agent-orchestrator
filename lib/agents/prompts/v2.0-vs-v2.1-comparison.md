# System Prompt v2.0 vs v2.1 Comparison

## Summary

**v2.1** is a **consolidation and clarification** of v2.0, not a feature addition. It addresses structural issues that emerged from review without changing core functionality.

## Key Metrics

| Metric | v2.0 | v2.1 | Change |
|--------|------|------|--------|
| Total lines | 125 | 197 | +72 |
| "CRITICAL" labels | 6 | 1 | -5 |
| Major sections | 10 (mixed) | 7 (focused) | Better organization |
| Redundant content | Yes (3 instances) | No | Eliminated |
| Template variable docs | No | Yes | Added |

**Note on line count:** v2.1 is longer because it:
- Adds clear examples (improves clarity)
- Adds decision trees (reduces ambiguity)
- Adds explanatory comments (aids maintenance)
- Removes redundancy (higher signal-to-noise ratio)

The effective "cognitive load" is LOWER despite more lines because the structure is clearer.

---

## What Changed

### 1. Reduced "CRITICAL" Overuse

**v2.0:**
- 6 sections marked "CRITICAL"
- Diluted impact of truly critical instructions

**v2.1:**
- 1 section marked "CRITICAL" (Tool Usage and Workflow Execution)
- Everything else is implied important by being in the prompt

**Why this matters:** When everything is critical, nothing is. Agents (and humans) scan for CRITICAL markers and may ignore the rest.

---

### 2. Consolidated Workflow Execution Rules

**v2.0:**
```
Lines 23-29: CRITICAL INSTRUCTIONS FOR TOOL USAGE
Lines 56-70: WORKFLOW EXECUTION PATTERN
Lines 63-70: CRITICAL WORKFLOW EXECUTION RULES
Lines 72-79: CONDITIONAL LOGIC IN WORKFLOWS
Lines 123: "Remember: You have access to tools..." (redundant)
```

**v2.1:**
```
## CRITICAL: Tool Usage and Workflow Execution
  ### Tool Activation Pattern
  ### Sequential Step Execution
  ### Conditional Logic
```

All in one place, no redundancy.

---

### 3. Clarified Action vs Ask Distinction

**v2.0 (ambiguous):**
```
Line 88-89: "When <action> tags suggest... You MAY provide 2-3 related items MAXIMUM"
Line 90-91: "When <ask> tags... Ask that ONE question clearly"
Line 96: "When asking the user DIRECTLY for input, ask ONE clear question"
```

Problem: What if `<action>` asks for input? 2-3 items or 1 question?

**v2.1 (explicit decision rule):**
```
### Question Cadence

When <ask> tags request input OR <action> says "Ask user for...":
→ Ask ONE clear question and STOP

When <action> says "Suggest questions..." or "Provide guidance...":
→ Provide 2-3 suggestions as helpful guidance

Decision Rule:
- <ask> tag OR action verb = "Ask" → ONE question, wait
- <action> verb = "Suggest/Provide/Offer" → 2-3 suggestions, continue
```

Now there's a clear decision tree.

---

### 4. Restructured Sections

**v2.0 Structure** (mixed concerns):
```
1. Agent identity/persona
2. CRITICAL INSTRUCTIONS FOR TOOL USAGE
3. FILE NAMING REQUIREMENTS (CRITICAL)
4. WORKFLOW EXECUTION PATTERN
5. CRITICAL WORKFLOW EXECUTION RULES
6. CONDITIONAL LOGIC IN WORKFLOWS
7. CONVERSATIONAL STYLE - Context-Aware Communication [tries to cover too much]
8. AVAILABLE TOOLS
9. ENVIRONMENT VARIABLES
10. CRITICAL EFFICIENCY RULE
11. CRITICAL USER COMMUNICATION RULE
12. Reminder about tools (redundant)
```

**v2.1 Structure** (focused sections):
```
1. Agent identity/persona
2. CRITICAL: Tool Usage and Workflow Execution [consolidated]
3. Action Tag Interpretation [clear decision trees]
4. User Communication [question cadence, style]
5. Output Formatting [analysis, context usage]
6. File Operations [naming, display]
7. Available Tools [with comments on template vars]
8. Environment Variables [with explanations]
9. Efficiency Notes [non-critical optimization tips]
```

Each section has a single, clear purpose.

---

### 5. Added Template Variable Documentation

**v2.0:**
```
Line 105: {{COMMANDS_SECTION}}
[No explanation of what this is]
```

**v2.1:**
```
{{COMMANDS_SECTION}}
<!-- Auto-generated from agent's <cmds> section - lists available commands like *help, *workflow-request, etc. -->
```

Now maintainers understand what gets populated where.

---

### 6. Added Decision Trees and Examples

**v2.0:** Describes patterns in prose, leaves interpretation open

**v2.1:** Adds visual decision trees:
```
Pattern 1: Agent Execution Actions
If <action> starts with: "Create", "Compile", "Identify", "Present"
→ YOU execute this using loaded context
→ Show your analysis (3-5 concise bullets)
→ THEN ask for user input/validation

Pattern: ANALYZE → PRESENT → ASK
```

Clearer mental model for the LLM.

---

### 7. Removed Redundancy

**v2.0 Redundancy:**
- Tool usage mentioned 3 times (lines 23-29, 101-104, 123)
- Workflow execution split across 4 sections
- "Wait for results" repeated multiple times

**v2.1:** Each instruction appears once, in its logical section.

---

## What Stayed the Same

Core functionality unchanged:
- ✅ Sequential step execution
- ✅ Action tag interpretation (Agent/Guidance/Meta patterns)
- ✅ Conditional logic handling
- ✅ File naming requirements
- ✅ Output conciseness guidelines
- ✅ Tool activation pattern

v2.1 is a **refactor**, not a **rewrite**.

---

## Expected Outcomes

### Positive
- **Reduced cognitive load** - clearer structure, less scanning
- **Less ambiguity** - decision trees resolve conflicts
- **Easier maintenance** - template variables documented, sections focused
- **Same behavior** - no new features means no new bugs

### Potential Risks
- **Line count increase** might look concerning, but it's clarifying content not bloat
- **Need to test** that consolidation didn't accidentally remove something important

---

## Testing Strategy

### Minimal Test (Quick validation)
1. Load Casey agent with v2.1
2. Run `*workflow-request` with intake file
3. Verify Step 2 response:
   - ✅ Shows step header once
   - ✅ Provides 3-5 contextual bullets
   - ✅ Suggests 2-3 example questions
   - ✅ Asks ONE direct question
   - ✅ No redundant tool usage reminders

### Comprehensive Test (Full validation)
Run same workflow with v2.0 vs v2.1 and compare:
- Tone and helpfulness (should be same)
- Step execution pattern (should be same)
- Context awareness (should be same)
- File naming behavior (should be same)

If behavior is identical, v2.1 is a successful consolidation.

---

## Migration Path

### Option 1: Direct replacement (recommended)
```bash
cp lib/agents/prompts/versions/v2.1-consolidated.md lib/agents/prompts/system-prompt.md
# Test thoroughly
# If successful, commit as v2.1
```

### Option 2: Gradual rollout
```bash
# Update systemPromptBuilder.ts to allow version selection
# Test v2.1 on one agent first
# Expand to all agents if successful
```

---

## Lessons from v3.x Failures

v3.0-v3.3 all failed because they **added complexity** to fix issues.

v2.1 takes the opposite approach: **simplify and clarify** the existing structure.

Key insight from CHANGELOG:
> "If your instructions need a glossary, rewrite the instructions instead"

v2.1 follows this principle - instead of adding meta-instructions about how to interpret instructions, it makes the instructions clearer.
