# Session Output Management Specification

**Version:** 1.0.0
**Date:** 2025-10-05
**Status:** Draft

---

## Overview

This specification defines how agent workflows organize and manage output files in the Agent Orchestrator system. All agent outputs are stored in a centralized, session-based structure that enables:

1. **Isolation**: Each agent execution gets its own unique session directory
2. **Discoverability**: Standardized manifest files enable cross-agent file discovery
3. **Traceability**: Clear lineage of which agent/workflow produced which files
4. **Human-readability**: Organized structure viewable through file browser (Epic 5)

---

## Directory Structure

All agent outputs are stored under a centralized location:

```
{output_folder}/
└── agent-outputs/
    ├── {session-uuid-1}/
    │   ├── manifest.json
    │   └── [agent-generated files and subdirectories]
    ├── {session-uuid-2}/
    │   ├── manifest.json
    │   └── [agent-generated files and subdirectories]
    └── ...
```

**Path Variables:**
- `{output_folder}`: Configured in bundle `config.yaml` (default: `{project-root}/docs`)
- `{session-uuid}`: UUID v4 generated by workflow engine at session start

---

## Session Identifier

**Format:** UUID v4 (RFC 4122)

**Example:** `a3f2c9d1-4b5e-6789-01ab-cdef12345678`

**Generation:**
- Created automatically by workflow engine when agent workflow starts
- Available to agents as `{{session_id}}` template variable
- Immutable for the duration of the session

**Benefits:**
- Guaranteed uniqueness (no collision risk)
- No semantic meaning (prevents hardcoded assumptions)
- Universally recognized format
- Sortable/indexable by external tools

---

## Manifest File Schema

Each session directory MUST contain a `manifest.json` file describing the session and its outputs.

### Manifest Structure

```json
{
  "version": "1.0.0",
  "session_id": "a3f2c9d1-4b5e-6789-01ab-cdef12345678",
  "agent": {
    "name": "alex",
    "title": "Alex the Facilitator",
    "bundle": "bmad/bmm"
  },
  "workflow": {
    "name": "intake-app",
    "description": "Initial requirements gathering for application development"
  },
  "execution": {
    "started_at": "2025-10-05T23:01:45.123Z",
    "completed_at": "2025-10-05T23:05:22.456Z",
    "status": "completed",
    "user": "Bryan"
  },
  "outputs": [
    {
      "file": "initial-requirements.md",
      "type": "document",
      "description": "Initial requirements document",
      "created_at": "2025-10-05T23:05:20.789Z"
    }
  ],
  "inputs": {
    "category": "Application Development",
    "request_type": "application"
  },
  "related_sessions": [
    "b4e3d8c2-5c6f-7890-12bc-def123456789"
  ],
  "metadata": {
    "custom_field": "value"
  },
  "displayName": "2:30p - I need to purchase 10 laptops...",
  "displayTimestamp": "2:30p",
  "userSummary": "I need to purchase 10 laptops for the...",
  "messageCount": 8
}
```

### Field Definitions

#### Top-Level Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `version` | string | Yes | Manifest schema version (semver) |
| `session_id` | string | Yes | UUID v4 session identifier |
| `agent` | object | Yes | Agent information |
| `workflow` | object | Yes | Workflow information |
| `execution` | object | Yes | Execution metadata |
| `outputs` | array | Yes | Array of output file records |
| `inputs` | object | No | Workflow input parameters |
| `related_sessions` | array | No | Array of related session UUIDs |
| `metadata` | object | No | Custom workflow-specific metadata |
| `displayName` | string | No | **Story 6.3:** Computed display name: "{smartTimestamp} - {summary (35 char max)}" |
| `displayTimestamp` | string | No | **Story 6.3:** Smart timestamp for sorting/grouping: "2:30p", "Yday 2:30p", "Mon 2:30p", "Oct 5" |
| `userSummary` | string | No | **Story 6.3:** First user message, truncated to 35 characters |
| `messageCount` | number | No | **Story 6.3:** Total number of messages in the conversation |

#### `agent` Object

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `name` | string | Yes | Agent identifier (e.g., "alex") |
| `title` | string | Yes | Human-readable agent title |
| `bundle` | string | Yes | Bundle path (e.g., "bmad/bmm") |

#### `workflow` Object

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `name` | string | Yes | Workflow identifier (e.g., "intake-app") |
| `description` | string | Yes | Workflow description from workflow.yaml |

#### `execution` Object

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `started_at` | string | Yes | ISO 8601 timestamp when workflow started |
| `completed_at` | string | No | ISO 8601 timestamp when workflow completed |
| `status` | enum | Yes | `"running"`, `"completed"`, `"failed"`, `"cancelled"` |
| `user` | string | Yes | User who initiated the session |

#### `outputs` Array Items

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `file` | string | Yes | Relative file path from session directory |
| `type` | string | Yes | File type: `"document"`, `"data"`, `"report"`, `"artifact"` |
| `description` | string | Yes | Human-readable description of file purpose |
| `created_at` | string | Yes | ISO 8601 timestamp when file was created |

---

## Manifest Lifecycle

### 1. Manifest Creation (Auto-Generated by Engine)

**When:** Workflow execution starts

**Populated Fields:**
```json
{
  "version": "1.0.0",
  "session_id": "{generated-uuid}",
  "agent": { /* from agent XML */ },
  "workflow": { /* from workflow.yaml */ },
  "execution": {
    "started_at": "{current-timestamp}",
    "status": "running",
    "user": "{from-config}"
  },
  "outputs": [],
  "inputs": { /* from workflow.yaml context variables */ }
}
```

### 2. Output Registration (Agent Responsibility)

Agents SHOULD register outputs as they create files.

**Example workflow instruction:**
```xml
<action>Save requirements to {{session_folder}}/requirements.md</action>
<action>Register output in manifest:
  - file: requirements.md
  - type: document
  - description: Initial requirements document
</action>
```

**Implementation:** Engine provides utility function/tool to append to `outputs[]` array.

### 3. Manifest Finalization (Auto-Generated by Engine)

**When:** Workflow execution completes (success or failure)

**Updated Fields:**
```json
{
  "execution": {
    "completed_at": "{current-timestamp}",
    "status": "completed" // or "failed"
  }
}
```

---

## Cross-Agent Session Discovery

### Use Case: Agent B needs to find output from Agent A

**Scenario:** Pixel needs Casey's requirements document to build stories.

**Discovery Pattern:**

1. **Search by agent + workflow pattern:**
   ```typescript
   findSessions({
     agent: "casey",
     workflow: /^deep-dive-/,
     status: "completed"
   })
   ```

2. **Read manifest to identify outputs:**
   ```typescript
   const sessions = findSessions({...});
   const latest = sessions.sort((a,b) =>
     b.execution.started_at - a.execution.started_at
   )[0];
   const reqDoc = latest.outputs.find(o => o.type === "document");
   ```

3. **Construct full path:**
   ```typescript
   const filePath = `{agent_outputs_folder}/${latest.session_id}/${reqDoc.file}`;
   ```

**Future Enhancement (Phase 2):**
- Add workflow task helper: `find_latest_output(agent, workflow_pattern, output_type)`
- UI search interface in file viewer

---

## Session Linking

Workflows can link related sessions via `related_sessions[]` array.

**Example Workflow Chain:**

1. Alex runs `intake-app` → Session UUID: `aaaa-bbbb-cccc-dddd`
2. Casey runs `deep-dive-app` → Session UUID: `eeee-ffff-gggg-hhhh`
   - Manifest includes: `"related_sessions": ["aaaa-bbbb-cccc-dddd"]`
3. Pixel runs `build-stories` → Session UUID: `iiii-jjjj-kkkk-llll`
   - Manifest includes: `"related_sessions": ["eeee-ffff-gggg-hhhh"]`

**Benefits:**
- Trace lineage of requirements → stories
- Visualize workflow chains in UI
- Enable "show related sessions" feature in file viewer

---

## Configuration Requirements

### Bundle config.yaml

**Minimum Required Variables:**
```yaml
output_folder: '{project-root}/docs'
agent_outputs_folder: '{output_folder}/agent-outputs'
```

### Workflow workflow.yaml

**Minimum Required Variables:**
```yaml
# Session variables (auto-populated by engine)
session_id: ""  # Engine generates UUID
session_folder: "{config_source}:agent_outputs_folder/{{session_id}}"
manifest_file: "{session_folder}/manifest.json"

# Output file paths (agent-specific)
default_output_file: "{session_folder}/output.md"
```

**Path Resolution:**
- `{config_source}:agent_outputs_folder` → resolves to absolute path via Epic 4's path resolver
- `{{session_id}}` → template replaced with generated UUID
- `{session_folder}` → combines above into session directory path

---

## File Naming Conventions

### Agent-Generated Files

**Rule:** Agents MAY use any file naming convention appropriate to their workflow.

**Examples:**
- ✅ `requirements.md`
- ✅ `initial-intake-20251005.md`
- ✅ `story-1.md`, `story-2.md`, ...
- ✅ `data/analysis.json`

**Rationale:** Different workflows have different output patterns. Standardizing names would limit flexibility.

**Best Practice:** Use descriptive names that indicate content and purpose.

### Subdirectories

**Rule:** Agents MAY create subdirectories within their session folder.

**Examples:**
```
{session-uuid}/
├── manifest.json
├── requirements.md
└── attachments/
    ├── wireframe.png
    └── data-model.json
```

---

## Security & Access Control

### Read-Only Access via File Viewer (Epic 5)

**Scope:** File viewer provides read-only access to `{agent_outputs_folder}` only.

**Security Requirements:**
1. Path validation ensures reads limited to `{agent_outputs_folder}` subdirectories
2. No write/edit/delete operations allowed through viewer
3. No access to bundle source files, agent definitions, or system directories
4. Session UUIDs prevent path traversal attacks (no semantic meaning to guess)

**Implementation:** Leverage Epic 4's PathSecurityValidator (Story 4.2).

---

## Migration from Current State

### Current Agent Output Paths

**Problem:** Agents currently use inconsistent paths:
- Alex: `{{project_slug}}/1-intake/initial-{{project_slug}}-{{date}}.md`
- Casey: `{{project_slug}}/2-requirements/detailed-{{project_slug}}-{{date}}.md`
- Pixel: `{{project_slug}}/3-stories/story-{{story_number}}.md`

**Issue:** No `project_slug` defined, outputs would save to project root.

### Migration Strategy

**Phase 1 (Pre-Epic 5):**
1. Add `agent_outputs_folder` to `bmad/bmm/config.yaml`
2. Update all active agent `workflow.yaml` files:
   - Add `session_id: ""`
   - Add `session_folder: "{config_source}:agent_outputs_folder/{{session_id}}"`
   - Update output paths to use `{session_folder}/...`
3. Update workflow engine to generate UUID and inject as `session_id`

**Phase 2 (Epic 5 Story 5.1):**
1. Implement manifest auto-generation
2. Add session discovery utilities
3. Update agent instructions to register outputs in manifest

**Backward Compatibility:**
- Existing docs in `docs/` remain untouched
- New agent executions use new structure
- No migration of old files required

---

## Implementation Checklist

- [ ] Add `agent_outputs_folder` to bundle config
- [ ] Update workflow engine to generate session UUIDs
- [ ] Implement manifest.json auto-generation
- [ ] Update all agent workflow.yaml files with session variables
- [ ] Create output registration utility for agents
- [ ] Add session discovery API for cross-agent references
- [ ] Document session structure in BUNDLE-SPEC.md
- [ ] Validate Epic 5 file viewer integration

---

## Display Name Convention (Story 5.2.1)

Session folders in the UI display human-readable names instead of UUIDs, generated from manifest metadata.

### Format

**Running Sessions:**
```
{agent.title} - {workflow.name} (In Progress)
```

**Completed Sessions:**
```
{agent.title} - {workflow.name} ({formatted_date})
```

### Examples

```
Alex the Facilitator - Intake ITSM (Oct 6, 2025, 5:09 PM)
Casey - Deep Dive Workflow (Oct 5, 2025, 2:30 PM)
Pixel - Build Stories (In Progress)
```

### Technical Implementation

- **Display Layer Only**: Technical paths (UUIDs) still used for file operations and security validation
- **Fallback Behavior**: Sessions without manifest.json show UUID (graceful degradation)
- **Timestamp Format**: Local time, 12-hour clock with AM/PM
- **Internal Files**: manifest.json files hidden from UI tree display (marked `isInternal: true`)

### Display Name Generation

The display name is generated by `lib/files/manifestReader.ts`:

1. Load `manifest.json` from session folder
2. Extract `agent.title`, `workflow.name`, `execution.status`, and timestamps
3. Format according to status (running vs. completed)
4. Use completed_at timestamp if available, otherwise started_at

**Implementation:**
- `parseManifest(sessionPath)`: Load and validate manifest.json
- `generateDisplayName(metadata)`: Generate human-readable name
- `formatTimestamp(isoString)`: Format ISO 8601 to readable date/time

---

## Future Enhancements (Out of Scope for Epic 5)

1. **Session Search API**: Full-text search across manifests and outputs
2. **Session Tagging**: Add tags to manifests for categorization
3. **Session Versioning**: Track multiple executions of same workflow
4. **Output Archival**: Move old sessions to archive after N days
5. **Session Deletion**: UI for cleaning up unwanted sessions
6. **Related Session Visualization**: Graph view showing workflow chains

---

## References

- Epic 4 Story 4.2: Path Resolution System
- Epic 5 Tech Spec: File Management and Viewer
- BUNDLE-SPEC.md: Bundle Configuration Standards
- RFC 4122: UUID Specification
